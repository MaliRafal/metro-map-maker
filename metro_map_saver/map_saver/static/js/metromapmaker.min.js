var lastStrokeStyle,gridRows=80,gridCols=80,activeTool="look",activeToolOption=!1,activeMap=!1,preferredGridPixelMultiplier=20,redrawOverlappingPoints={},dragX=!1,dragY=!1,clickX=!1,clickY=!1,hoverX=!1,hoverY=!1,temporaryStation={},pngUrl=!1,mapHistory=[],maxUndoHistory=25,currentlyClickingAndDragging=!1,mapLineWidth=1,mapStationStyle="wmata",menuIsCollapsed=!1,mapSize=void 0;if(MMMDEBUG=!1,void 0===mapDataVersion)var mapDataVersion=void 0;function compatibilityModeIndicator(){1==mapDataVersion?($(".M:not(.mobile)").css({"background-color":"#bd1038"}),$("#title").css({color:"#bd1038"}),$("#tool-move-v1-warning").attr("style","")):($(".M:not(.mobile)").css({"background-color":"#000"}),$("#title").css({color:"#000"}),$("#tool-move-v1-warning").attr("style","display: none"))}compatibilityModeIndicator();const numberKeys=["Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0","Digit1","Digit2","Digit3","Digit4","Digit5","Digit6","Digit7","Digit8","Digit9","Digit0"],ALLOWED_ORIENTATIONS=[0,45,-45,90,-90,135,-135,180],ALLOWED_STYLES=["wmata","rect","rect-round","circles-lg","circles-md","circles-sm","circles-thin"],ALLOWED_SIZES=[80,120,160,200,240];function resizeGrid(e){if(e=parseInt(e),gridRows=e,gridCols=e,2==mapDataVersion)for(var t in activeMap.points_by_color){for(var i=e;i<ALLOWED_SIZES[ALLOWED_SIZES.length-1];i++)activeMap.points_by_color[t].xys[i]&&delete activeMap.points_by_color[t].xys[i],activeMap.stations&&activeMap.stations[i]&&delete activeMap.stations[i];for(i=0;i<e;i++)for(var a=0;a<ALLOWED_SIZES[ALLOWED_SIZES.length-1];a++)a>=e&&activeMap.points_by_color[t].xys[i]&&activeMap.points_by_color[t].xys[i][a]&&delete activeMap.points_by_color[t].xys[i][a],a>=e&&activeMap.stations&&activeMap.stations[i]&&activeMap.stations[i][a]&&delete activeMap.stations[i][a]}else if(1==mapDataVersion){for(i=e;i<ALLOWED_SIZES[ALLOWED_SIZES.length-1];i++)delete activeMap[i];for(i=0;i<e;i++)for(a=0;a<ALLOWED_SIZES[ALLOWED_SIZES.length-1];a++)a>=e&&activeMap[i]&&activeMap[i][a]&&delete activeMap[i][a]}drawGrid(),snapCanvasToGrid(),lastStrokeStyle=void 0,drawCanvas(activeMap)}function resizeCanvas(e){var t=$("#canvas-container").width();step=gridCols,"out"==e&&t>=800?t-=step:"in"==e&&t<=6400?t+=step:Number.isNaN(e)||(t=parseInt(e)),t<800&&(t=800),t>6400&&(t=6400),window.sessionStorage.setItem("zoomLevel",t),$("#canvas-container").width(t),$("#canvas-container").height(t)}function snapCanvasToGrid(){var e=3600,t=document.getElementById("metro-map-canvas"),i=document.getElementById("metro-map-stations-canvas");t.height/gridCols!=preferredGridPixelMultiplier&&(gridCols*preferredGridPixelMultiplier<=e?(t.height=gridCols*preferredGridPixelMultiplier,i.height=gridCols*preferredGridPixelMultiplier):(t.height=e,i.height=e),gridRows*preferredGridPixelMultiplier<=e?(t.width=gridRows*preferredGridPixelMultiplier,i.width=gridRows*preferredGridPixelMultiplier):(t.width=e,i.width=e)),$("#canvas-container").height($("#metro-map-canvas").height()),$("#canvas-container").width($("#metro-map-canvas").height())}function coordinateInColor(e,t,i,a){return a||1!=mapDataVersion?1==mapDataVersion?getActiveLine(e,t,i)==a:!!(i.points_by_color[a]&&i.points_by_color[a].xys&&i.points_by_color[a].xys[e]&&i.points_by_color[a].xys[e][t]):getActiveLine(e,t,i)}function getActiveLine(e,t,i){if(2==mapDataVersion&&i.global.lines){for(var a in i.points_by_color)if(coordinateInColor(e,t,i,a))return a}else{if(i&&i[e]&&i[e][t]&&i[e][t].line)return i[e][t].line;if(!i)return!1}}function getStation(e,t,i){return i&&2==mapDataVersion&&i.stations&&i.stations[e]?i.stations[e][t]:i&&i[e]&&i[e][t]&&i[e][t].station?i[e][t].station:!!i&&void 0}function moveLineStroke(e,t,i,a,o){e.moveTo(t*gridPixelMultiplier,i*gridPixelMultiplier),e.lineTo(a*gridPixelMultiplier,o*gridPixelMultiplier),singleton=!1}function determineDarkOrLightContrast(e){total=0,rgb=[...e.matchAll(/(\d+)/g)];for(var t=0;t<rgb.length;t++)total+=parseInt(rgb[t][0]);return total<381?"#ffffff":"#000000"}function bindRailLineEvents(){$(".rail-line").click((function(){activeTool="line",activeToolOption=$(this).css("background-color"),$("#tool-line").addClass("draw-rail-line"),activeToolOption&&$("#tool-line").css({"background-color":activeToolOption,color:determineDarkOrLightContrast(activeToolOption)}),$("#tool-flood-fill").prop("checked")?(floodFill(hoverX,hoverY,getActiveLine(hoverX,hoverY,activeMap),activeToolOption,!0),$("#tool-line-icon-pencil").hide(),$("#tool-line-icon-paint-bucket").show()):(drawNewHoverIndicator(),$("#tool-line-icon-pencil").show(),$("#tool-line-icon-paint-bucket").hide()),$("#tool-station-options").hide()}))}function makeLine(e,t,i){drawArea(e,t,activeMap,!0);var a=rgb2hex(activeToolOption).slice(1,7);metroMap=updateMapObject(e,t,"line",a),i||autoSave(metroMap),drawArea(e,t,metroMap)}function makeStation(e,t){if(temporaryStation={},!getActiveLine(e,t,activeMap))return activeToolOption?$("#tool-station").removeClass("width-100"):($("#tool-station").addClass("active"),$("#tool-line").removeClass("width-100"),$("#tool-line").removeClass("active")),$("#tool-station-options").hide(),void drawCanvas(activeMap,!0);$("#station-name").val(""),$("#station-coordinates-x").val(e),$("#station-coordinates-y").val(t);$(".rail-line");if($("#tool-station").addClass("width-100"),getStation(e,t,activeMap)){if(getStation(e,t,activeMap).name){var i=getStation(e,t,activeMap).name.replaceAll("_"," ");$("#station-name").val(i),getStation(e,t,activeMap).transfer?$("#station-transfer").prop("checked",!0):$("#station-transfer").prop("checked",!1),document.getElementById("station-name-orientation").value=parseInt(getStation(e,t,activeMap).orientation),document.getElementById("station-style").value=getStation(e,t,activeMap).style||""}}else{temporaryStation={name:""},$("#station-transfer").prop("checked",!1);var a=window.localStorage.getItem("metroMapStationOrientation");a?(document.getElementById("station-name-orientation").value=a,$("#station-name-orientation").change()):document.getElementById("station-name-orientation").value=0,document.getElementById("station-style").value=""}getActiveLine(e,t,activeMap)&&(drawCanvas(activeMap,!0),drawIndicator(e,t),$("#tool-station-options").show()),$("#station-name").focus()}function bindGridSquareEvents(e){if($("#station-coordinates-x").val(""),$("#station-coordinates-y").val(""),e.isTrusted)t=getCanvasXY(e.pageX,e.pageY);else var t=getCanvasXY(dragX,dragY);var i=t[0],a=t[1];if(e.isTrusted){if(currentlyClickingAndDragging)return}else{if(i==clickX||a==clickY);else if(Math.abs(i-clickX)==Math.abs(a-clickY));else if($("#straight-line-assist").prop("checked"))return;currentlyClickingAndDragging=!0}if("line"==activeTool)$("#tool-flood-fill").prop("checked")?(floodFill(i,a,getActiveLine(i,a,activeMap),rgb2hex(activeToolOption).slice(1,7)),autoSave(activeMap),drawCanvas(activeMap)):makeLine(i,a);else if("eraser"==activeTool){var o=getActiveLine(i,a,activeMap);if(getStation(i,a,activeMap))var n=!0;else n=!1;o&&$("#tool-flood-fill").prop("checked")?(floodFill(i,a,o,""),drawCanvas(activeMap)):(metroMap=updateMapObject(i,a),autoSave(metroMap),drawArea(i,a,metroMap,o,n))}else"station"==activeTool&&makeStation(i,a)}function bindGridSquareMouseover(e){if(MMMDEBUG&&$("#title").text(["XY: "+getCanvasXY(e.pageX,e.pageY)]),xy=getCanvasXY(e.pageX,e.pageY),hoverX=xy[0],hoverY=xy[1],mouseIsDown||$("#tool-flood-fill").prop("checked")){if(!mouseIsDown&&(activeToolOption||"eraser"==activeTool)&&$("#tool-flood-fill").prop("checked")){if("line"==activeTool&&activeToolOption)indicatorColor=activeToolOption;else{if("line"!=activeTool&&"eraser"!=activeTool)return void drawHoverIndicator(e.pageX,e.pageY);indicatorColor="#ffffff"}floodFill(hoverX,hoverY,getActiveLine(hoverX,hoverY,activeMap),indicatorColor,!0)}}else drawHoverIndicator(e.pageX,e.pageY);!mouseIsDown||"line"!=activeTool&&"eraser"!=activeTool||(dragX=e.pageX,dragY=e.pageY,$("#canvas-container").click())}function bindGridSquareMouseup(e){"station"==activeTool&&"text"!=document.activeElement.type&&$("#station-name").focus(),clickX=!1,clickY=!1,mouseIsDown=!1,drawHoverIndicator(e.pageX,e.pageY)}function bindGridSquareMousedown(e){if(xy=getCanvasXY(e.pageX,e.pageY),clickX=xy[0],clickY=xy[1],$("#straight-line-assist").prop("checked")&&("line"==activeTool||"eraser"==activeTool))for(var t=0;t<gridRows;t++)for(var i=0;i<gridCols;i++)t!=clickX&&i!=clickY&&Math.abs(t-clickX)!=Math.abs(i-clickY)||drawHoverIndicator(t,i,"#2E71CC");mouseIsDown&&dragX||(mouseIsDown=!0,currentlyClickingAndDragging=!1)}function drawHoverIndicator(e,t,i,a){var o=document.getElementById("hover-canvas"),n=o.getContext("2d");if(i||(n.clearRect(0,0,o.width,o.height),xy=getCanvasXY(e,t),e=xy[0],t=xy[1]),n.globalAlpha=a||.5,"line"==activeTool&&activeToolOption&&rgb2hex(activeToolOption))var l="#"+rgb2hex(activeToolOption).slice(1,7);else if("eraser"!=activeTool||getActiveLine(e,t,activeMap)){if("eraser"==activeTool)l="#ffffff"}else var l="#000000";n.fillStyle=i||l||"#2ECC71";var r=o.width/gridCols;n.fillRect(e*r-r/2,t*r-r/2,r,r)}function drawNewHoverIndicator(){var e=document.getElementById("hover-canvas"),t=e.getContext("2d");t.save(),t.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height),t.globalAlpha=.75,t.fillStyle=activeToolOption,t.globalCompositeOperation="source-in",t.fillRect(0,0,e.width,e.height),t.restore()}function drawGrid(){var e=document.getElementById("grid-canvas"),t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),t.globalAlpha=.5,t.strokeStyle="#80CEFF",gridPixelMultiplier=e.width/gridCols;for(var i=0;i<gridCols;i++)t.beginPath(),t.moveTo(i*gridPixelMultiplier+gridPixelMultiplier/2,0),t.lineTo(i*gridPixelMultiplier+gridPixelMultiplier/2,e.height),t.stroke(),t.closePath();for(var a=0;a<gridRows;a++)t.beginPath(),t.moveTo(0,a*gridPixelMultiplier+gridPixelMultiplier/2),t.lineTo(e.width,a*gridPixelMultiplier+gridPixelMultiplier/2),t.stroke(),t.closePath()}function getRedrawSection(e,t,i,a){redrawSection={};for(var o=-1*(a=parseInt(a));o<=a;o+=1)for(var n=-1*a;n<=a;n+=1)getActiveLine(e+o,t+n,i)&&(redrawSection.hasOwnProperty(e+o)||(redrawSection[e+o]={}),redrawSection[e+o][t+n]=!0);return redrawSection}function drawArea(e,t,i,a,o){var n=document.getElementById("metro-map-canvas"),l=n.getContext("2d",{alpha:!1});gridPixelMultiplier=n.width/gridCols;var r=20;gridPixelMultiplier>20&&(r=gridPixelMultiplier);for(var e in e=parseInt(e),t=parseInt(t),l.lineWidth=gridPixelMultiplier*mapLineWidth,l.lineCap="round","eraser"==activeTool&&a&&drawPoint(l,e,t,i,a),redrawSection=getRedrawSection(e,t,i,1),redrawSection)for(var t in redrawSection[e])lastStrokeStyle=void 0,e=parseInt(e),t=parseInt(t),"line"==activeTool&&a?drawPoint(l,e,t,i,getActiveLine(e,t,i)):drawPoint(l,e,t,i);if(redrawSection&&!o){var s=(c=document.getElementById("metro-map-stations-canvas")).getContext("2d",{alpha:!0});for(var e in s.font="700 "+r+"px sans-serif",redrawSection)for(var t in redrawSection[e])drawStation(s,e=parseInt(e),t=parseInt(t),i,!0)}else if(o){var c;if((s=(c=document.getElementById("metro-map-stations-canvas")).getContext("2d",{alpha:!0})).clearRect(0,0,c.width,c.height),s.font="700 "+r+"px sans-serif",2==mapDataVersion)for(var e in i.stations)for(var t in i.stations[e])drawStation(s,e=parseInt(e),t=parseInt(t),i);else if(1==mapDataVersion)for(var e in i)for(var t in i[e])e=parseInt(e),t=parseInt(t),Number.isInteger(e)&&Number.isInteger(t)&&drawStation(s,e,t,i)}}function findLines(e){if(activeMap&&activeMap.points_by_color&&activeMap.points_by_color[e]&&activeMap.points_by_color[e].xys){var t={E:new Set,S:new Set,NE:new Set,SE:new Set},i=[],a=new Set,o=new Set;for(var n of["E","S","NE","SE"])for(var l in activeMap.points_by_color[e].xys)for(var r in activeMap.points_by_color[e].xys[l]){var s=l+","+r;if(!t[n].has(s)){var c=findEndpointOfLine(l,r,activeMap.points_by_color[e].xys,n);if(c)for(var p of(i.push([parseInt(l),parseInt(r),c.x1,c.y1]),o.add(s),o.add(c.x1+","+c.y1),c.between))o.add(p),t[n].add(p);else o.has(s)||a.add(s)}}if("function"==typeof a.difference)var d=a.difference(o);else{d=new Set;for(var v of a)o.has(v)||d.add(v)}return{lines:i,singletons:d}}}function findEndpointOfLine(e,t,i,a){var o=[e+","+t];directions={E:{dx:1,dy:0},S:{dx:0,dy:1},NE:{dx:1,dy:-1},SE:{dx:1,dy:1},SW:{dx:-1,dy:1}};var n=directions[a].dx,l=directions[a].dy,r=parseInt(e)+n,s=parseInt(t)+l;if(i&&i[e]&&i[e][t]&&i[r]&&i[r][s]){for(;i[r]&&i[r][s];){o.push(r+","+s);r=parseInt(r)+n,s=parseInt(s)+l}var c=o[o.length-1].split(",");return{between:o,x1:r=parseInt(c[0]),y1:s=parseInt(c[1])}}}function drawCanvas(e,t,i){if(t0=performance.now(),t);else{var a=(f=document.getElementById("metro-map-canvas")).getContext("2d",{alpha:!1});gridPixelMultiplier=Math.floor(f.width/gridCols);var o=gridPixelMultiplier;if(a.fillStyle="#ffffff",a.fillRect(0,0,f.width,f.height),i)return;if(e||(e=activeMap),activeMap=e,a.lineWidth=mapLineWidth*gridPixelMultiplier,a.lineCap="round",2==mapDataVersion)for(var n in e.points_by_color){a.strokeStyle="#"+n;var l=findLines(n),r=l.lines,s=l.singletons;for(var c of r)a.beginPath(),moveLineStroke(a,c[0],c[1],c[2],c[3]),a.stroke(),a.closePath();for(var p of s){var d=p.split(","),v=d[0],g=d[1];a.strokeStyle="#"+n,drawPoint(a,v,g,e,!1,n)}}else if(1==mapDataVersion){for(var v in e)for(var g in e[v])v=parseInt(v),g=parseInt(g),Number.isInteger(v)&&Number.isInteger(g)&&drawPoint(a,v,g,e);for(var m=Object.keys(redrawOverlappingPoints).reverse(),h=0;h<m.length;h++){v=m[h];for(var g in redrawOverlappingPoints[v])drawPoint(a,v=parseInt(v),g=parseInt(g),e)}redrawOverlappingPoints={}}}var f;a=(f=document.getElementById("metro-map-stations-canvas")).getContext("2d",{alpha:!0});gridPixelMultiplier=Math.floor(f.width/gridCols);o=gridPixelMultiplier;if(a.font="700 "+o+"px sans-serif",a.clearRect(0,0,f.width,f.height),2==mapDataVersion)for(var v in e.stations)for(var g in e.stations[v])drawStation(a,v=parseInt(v),g=parseInt(g),e);else if(1==mapDataVersion)for(var v in e)for(var g in e[v])v=parseInt(v),g=parseInt(g),Number.isInteger(v)&&Number.isInteger(g)&&drawStation(a,v,g,e);a.font="700 "+o+"px sans-serif",a.fillStyle="#000000";var u="Created with MetroMapMaker.com",y=a.measureText(u).width;a.fillText(u,gridRows*gridPixelMultiplier-y,gridCols*gridPixelMultiplier-50);var $=document.getElementById("shareable-map-link");if($&&($=$.text).length>0&&"https://metromapmaker.com/"==$.slice(0,26)){var M="Remix this map! Go to "+$;y=a.measureText(M).width;a.fillText(M,gridRows*gridPixelMultiplier-y,gridCols*gridPixelMultiplier-25)}t1=performance.now(),MMMDEBUG&&console.log("drawCanvas finished in "+(t1-t0)+"ms")}function drawPoint(e,t,i,a,o,n,l){if(i=parseInt(i),(n=n||getActiveLine(t,i,a))||"eraser"==activeTool){e.beginPath(),lastStrokeStyle&&lastStrokeStyle==n||(e.strokeStyle="#"+n,lastStrokeStyle=n),o&&(e.strokeStyle="#ffffff",n=o),singleton=!0,coordinateInColor(t+1,i+1,a,n)&&(moveLineStroke(e,t,i,t+1,i+1),redrawOverlappingPoints[t]||(redrawOverlappingPoints[t]={}),redrawOverlappingPoints[t][i]=!0),coordinateInColor(t-1,i-1,a,n)&&moveLineStroke(e,t,i,t-1,i-1),coordinateInColor(t+1,i-1,a,n)&&moveLineStroke(e,t,i,t+1,i-1),coordinateInColor(t-1,i+1,a,n)&&moveLineStroke(e,t,i,t-1,i+1),coordinateInColor(t+1,i,a,n)&&moveLineStroke(e,t,i,t+1,i),coordinateInColor(t-1,i,a,n)&&moveLineStroke(e,t,i,t-1,i),coordinateInColor(t,i+1,a,n)&&moveLineStroke(e,t,i,t,i+1),coordinateInColor(t,i-1,a,n)&&moveLineStroke(e,t,i,t,i-1);var r=getStation(t,i,a);singleton?(e.fillStyle=o?"#ffffff":"#"+n,"rect"==mapStationStyle||r&&"rect"==r.style?e.fillRect((t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,gridPixelMultiplier,gridPixelMultiplier):"circles-md"==mapStationStyle||r&&"circles-md"==r.style?(e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,.7*gridPixelMultiplier,0,2*Math.PI,!0),e.fill()):"circles-sm"==mapStationStyle||r&&"circles-sm"==r.style?(e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,.5*gridPixelMultiplier,0,2*Math.PI,!0),e.fill()):(e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,.9*gridPixelMultiplier,0,2*Math.PI,!0),e.fill())):e.stroke(),e.closePath()}}function drawStation(e,t,i,a,o){var n=getStation(t,i,a);if(n){var l=n.transfer,r=n.style||mapStationStyle,s=!1;if(r&&"wmata"!=r)if("circles-lg"==r){drawStyledStation_WMATA(e,t,i,a,l,"#"+getActiveLine(t,i,a))}else"circles-md"==r?drawCircleStation(e,t,i,a,l,.3,gridPixelMultiplier/2):"circles-sm"==r?drawCircleStation(e,t,i,a,l,.25,gridPixelMultiplier/4):"rect"==r?s=drawStyledStation_rectangles(e,t,i,a,l,0,0):"rect-round"!=r&&"circles-thin"!=r||(s=drawStyledStation_rectangles(e,t,i,a,l,0,0,20));else drawStyledStation_WMATA(e,t,i,a,l);o||drawStationName(e,t,i,a,l,s)}}function drawStationName(e,t,i,a,o,n){e.fillStyle="#000000",e.save();var l=getStation(t,i,a),r=l.name.replaceAll("_"," "),s=parseInt(l.orientation),c=e.measureText(r).width;if(o)var p=1.5*gridPixelMultiplier;else if(n)p=gridPixelMultiplier;else p=.75*gridPixelMultiplier;var d=.25*gridPixelMultiplier;-45==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-45),e.fillText(r,p,d)):45==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*45),e.fillText(r,p,d)):-90==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-90),e.fillText(r,-1*c-p,d)):90==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-90),e.fillText(r,p,d)):135==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*-45),e.fillText(r,-1*c-p,d)):-135==s?(e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(Math.PI/180*45),e.fillText(r,-1*c-p,d)):180==s?o?e.fillText(r,t*gridPixelMultiplier-1.5*gridPixelMultiplier-c,i*gridPixelMultiplier+gridPixelMultiplier/4):e.fillText(r,t*gridPixelMultiplier-gridPixelMultiplier-c,i*gridPixelMultiplier+gridPixelMultiplier/4):o?e.fillText(r,t*gridPixelMultiplier+1.5*gridPixelMultiplier,i*gridPixelMultiplier+gridPixelMultiplier/4):e.fillText(r,t*gridPixelMultiplier+gridPixelMultiplier,i*gridPixelMultiplier+gridPixelMultiplier/4),e.restore()}function drawStyledStation_WMATA(e,t,i,a,o,n,l){n||(n="#000000"),l||(l="#ffffff"),o&&(drawCircleStation(e,t,i,a,o,1.2,0,n,0,!0),drawCircleStation(e,t,i,a,o,.9,0,l,0,!0)),drawCircleStation(e,t,i,a,o,.6,0,n,0,!0),drawCircleStation(e,t,i,a,o,.3,0,l,0,!0)}function drawCircleStation(e,t,i,a,o,n,l,r,s,c){o&&!r&&(r="#"+getActiveLine(t,i,a)),!s&&o&&mapLineWidth>=.5&&(s="#ffffff",l=gridPixelMultiplier/2),e.fillStyle=r||"#ffffff",e.beginPath(),e.arc(t*gridPixelMultiplier,i*gridPixelMultiplier,gridPixelMultiplier*n,0,2*Math.PI,!0),e.closePath(),c||(e.lineWidth=l,e.strokeStyle=s||"#"+getActiveLine(t,i,a),e.stroke()),e.fill()}function drawStyledStation_rectangles(e,t,i,a,o,n,l,r,s){var c="#"+getActiveLine(t,i,a),p=getLineDirection(t,i,a).direction,d=[],v=!1,g=getConnectedStations(t,i,a),m=getStation(t,i,a),h=gridPixelMultiplier,f=gridPixelMultiplier;if(mapLineWidth>=.5&&"singleton"!=p||"singleton"==p&&("rect-round"==mapStationStyle||m&&"rect-round"==m.style)?(e.strokeStyle="#000000",e.fillStyle="#ffffff"):(e.strokeStyle=c,e.fillStyle=c),!0===g)h=gridPixelMultiplier/2;else if(m&&g&&"singleton"!=g&&"conflicting"!=g)dx=g.x1-g.x0,dy=g.y1-g.y0,h=(Math.abs(dx)+1)*gridPixelMultiplier,f=(Math.abs(dy)+1)*gridPixelMultiplier,v=!0,dx>0&&0==dy?p="horizontal":0==dx&&dy>0?p="vertical":dx>0&&dy>0?(p="diagonal-ne",h=gridPixelMultiplier):dx>0&&dy<0&&(p="diagonal-ne",f=gridPixelMultiplier);else{if(!g&&!s)return;"singleton"==g&&("singleton"==p?(e.strokeStyle="#000000",mapLineWidth<.5&&("rect-round"==mapStationStyle||m&&"rect-round"==m.style)&&(e.fillStyle=c)):o||(h=gridPixelMultiplier/2))}function u(a,o){if(e.save(),e.translate(t*gridPixelMultiplier,i*gridPixelMultiplier),e.rotate(o),v&&h>f){var n=h/gridPixelMultiplier;h+=n<4?n*(gridPixelMultiplier/4):n*(gridPixelMultiplier/3)}else if(v&&f>h){n=f/gridPixelMultiplier;f+=n<4?n*(gridPixelMultiplier/4):n*(gridPixelMultiplier/3)}MMMDEBUG&&t==$("#station-coordinates-x").val()&&i==$("#station-coordinates-y").val()&&console.log(`stationSpan: ${n}, w1: ${h} h1: ${f}`),r?primitiveRoundRect(e,...a,h,f,r):(e.strokeRect(...a,h,f),e.fillRect(...a,h,f)),e.restore()}if(v&&!s&&(e.strokeStyle="#000000",e.fillStyle="#ffffff"),(!v||!m&&s)&&("rect-round"==mapStationStyle||m&&"rect-round"==m.style)&&(r=2),m&&"rect"==m.style&&(r=!1),e.lineWidth=o?gridPixelMultiplier/2:gridPixelMultiplier/4,s&&!1===g&&(h>f&&(h=f),v=!0),"conflicting"==g&&(p="singleton",h>f&&(h=f),v=!1),n&&(e.strokeStyle=n),l&&(e.fillStyle=l),MMMDEBUG&&t==$("#station-coordinates-x").val()&&i==$("#station-coordinates-y").val()&&console.log(`xy: ${t},${i}; wh: ${h},${f} xf: ${o} ld: ${p} ra: ${d} cs: ${g} dac: ${v} sC: ${n} fC: ${l}`),!v&&("circles-thin"==mapStationStyle&&m&&!m.style||m&&"circles-thin"==m.style))return s||(n="#000000",l="#ffffff"),void drawCircleStation(e,t,i,activeMap,o,.5,e.lineWidth,l,n);if("singleton"==p||!m&&s&&("horizontal"==p||"vertical"==p))d=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,h,f];else if("horizontal"==p&&(v||o))d=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,h,f];else if("horizontal"!=p||v)if("vertical"==p&&(v||o))d=[(t-.5)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,h,f];else if("vertical"!=p||v){if("diagonal-ne"==p&&(v||o))return void u([-.5*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/-4);if("diagonal-ne"==p&&!v)return void u([-.25*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/-4);if("diagonal-se"==p&&(v||o))return void u([-.5*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/4);if("diagonal-se"==p&&!v)return void u([-.25*gridPixelMultiplier,-.5*gridPixelMultiplier],Math.PI/4)}else d=[(t-.5)*gridPixelMultiplier,(i-.25)*gridPixelMultiplier,f,h];else d=[(t-.25)*gridPixelMultiplier,(i-.5)*gridPixelMultiplier,h,f];return r?primitiveRoundRect(e,...d,r):(e.strokeRect(...d),e.fillRect(...d)),v}function primitiveRoundRect(e,t,i,a,o,n){a<2*n&&(n=a/2),o<2*n&&(n=o/2),e.beginPath(),e.moveTo(t+n,i),e.arcTo(t+a,i,t+a,i+o,n),e.arcTo(t+a,i+o,t,i+o,n),e.arcTo(t,i+o,t,i,n),e.arcTo(t,i,t+a,i,n),e.stroke(),e.fill(),e.closePath()}function drawIndicator(e,t){var i=document.getElementById("metro-map-stations-canvas"),a=i.getContext("2d",{alpha:!1}),o=i.width/gridCols;if(getActiveLine(e,t,activeMap)){var n=getStation(e,t,activeMap),l=mapStationStyle;temporaryStation.style?l=temporaryStation.style:n&&n.style&&(l=n.style);var r=temporaryStation.transfer||n&&n.transfer;l&&"wmata"!=l&&"circles-lg"!=l?"circles-md"==l?drawCircleStation(a,e,t,activeMap,r,.3,o/2,"#00ff00","#000000"):"circles-sm"==l?drawCircleStation(a,e,t,activeMap,r,.25,o/4,"#00ff00","#000000"):"rect"==l?drawStyledStation_rectangles(a,e,t,activeMap,r,"#000000","#00ff00",!1,!0):"rect-round"!=l&&"circles-thin"!=l||drawStyledStation_rectangles(a,e,t,activeMap,r,"#000000","#00ff00",20,!0):drawStyledStation_WMATA(a,e,t,activeMap,r,"#000000","#00ff00")}}function rgb2hex(e){if(/^#[0-9A-F]{6}$/i.test(e))return e;function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return"#"+t((e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))[1])+t(e[2])+t(e[3])}function saveMapHistory(e){mapHistory.length>=maxUndoHistory&&mapHistory.shift(),JSON.stringify(mapHistory[mapHistory.length-1])!=JSON.stringify(e)&&mapHistory.push(JSON.parse(JSON.stringify(e)))}function autoSave(e){"object"==typeof e&&(saveMapHistory(activeMap=e),e=JSON.stringify(e)),window.localStorage.setItem("metroMap",e),menuIsCollapsed||($("#autosave-indicator").text("Saving locally ..."),$("#title").hide(),setTimeout((function(){$("#autosave-indicator").text(""),$("#title").show()}),1500))}function undo(){if(mapHistory.length>1)mapHistory.pop(),previousMap=mapHistory[mapHistory.length-1];else{if(1!=mapHistory.length)return;previousMap=mapHistory.pop()}previousMap&&($(".rail-line").remove(),loadMapFromObject(previousMap),setMapSize(previousMap),drawCanvas(previousMap),resetResizeButtons(gridCols),resetRailLineTooltips())}function getURLParameter(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null}function autoLoad(){if("undefined"!=typeof savedMapData)activeMap=savedMapData;else{if(!window.localStorage.getItem("metroMap"))return $.get("/load/2LVHmJ3r").done((function(e){activeMap=e,"[ERROR]"==e.replace(/\s/g,"").slice(0,7)?(drawGrid(),bindRailLineEvents(),drawCanvas()):(setMapStyle(activeMap=JSON.parse(activeMap)),mapDataVersion=activeMap&&activeMap.global&&activeMap.global.data_version?activeMap.global.data_version:1,compatibilityModeIndicator(),mapSize=setMapSize(activeMap,mapDataVersion>1),loadMapFromObject(activeMap),setTimeout((function(){$("#tool-resize-"+gridRows).text("Initial size ("+gridRows+"x"+gridCols+")")}),1e3))})).fail((function(e){drawGrid(),bindRailLineEvents(),drawCanvas()})),void("undefined"!=typeof autoLoadError&&(autoLoadError+="Loading the default map.",$("#announcement").append('<h4 id="autoLoadError" class="bg-warning" style="text-align: left;">'+autoLoadError+"</h4>"),setTimeout((function(){$("#autoLoadError").remove()}),3e3)));activeMap=JSON.parse(window.localStorage.getItem("metroMap")),"undefined"!=typeof autoLoadError&&(autoLoadError+="Loading your last-edited map.")}setMapStyle(activeMap),mapDataVersion=activeMap&&activeMap.global&&activeMap.global.data_version?activeMap.global.data_version:1,compatibilityModeIndicator(),mapSize=setMapSize(activeMap,mapDataVersion>1),loadMapFromObject(activeMap),"undefined"!=typeof autoLoadError&&($("#announcement").append('<h4 id="autoLoadError" class="bg-warning" style="text-align: left;">'+autoLoadError+"</h4>"),setTimeout((function(){$("#autoLoadError").remove()}),3e3)),setTimeout((function(){$("#tool-resize-"+gridRows).text("Initial size ("+gridRows+"x"+gridCols+")")}),1e3);var e=window.sessionStorage.getItem("zoomLevel");e&&resizeCanvas(e)}function getMapSize(e){var t=0;if("object"!=typeof e&&(e=JSON.parse(e)),2==mapDataVersion)for(var i in e.points_by_color){for(var a in thisColorHighestValue=Math.max(...Object.keys(e.points_by_color[i].xys).map(Number).filter(Number.isInteger).filter((function(t){return Object.keys(e.points_by_color[i].xys[t]).length>0}))),e.points_by_color[i].xys){if(thisColorHighestValue>=200){t=thisColorHighestValue;break}y=Math.max(...Object.keys(e.points_by_color[i].xys[a]).map(Number).filter(Number.isInteger)),y>thisColorHighestValue&&(thisColorHighestValue=y)}thisColorHighestValue>t&&(t=thisColorHighestValue)}else if(1==mapDataVersion)for(var a in t=Math.max(...Object.keys(e).map(Number).filter(Number.isInteger).filter((function(t){return Object.keys(e[t]).length>0}))),e){if(t>=200)break;y=Math.max(...Object.keys(e[a]).map(Number).filter(Number.isInteger).filter((function(t){return Object.keys(e[a][t]).length>0}))),y>t&&(t=y)}return t}function setMapSize(e,t){if(t)gridRows=e.global.map_size,gridCols=e.global.map_size;else for(allowedSize of(highestValue=getMapSize(e),ALLOWED_SIZES))if(highestValue<allowedSize){gridRows=allowedSize,gridCols=allowedSize,e.global.map_size=gridRows;break}resizeGrid(gridRows),$("#canvas-container").width(Math.round($("#canvas-container").width()/gridCols)*gridCols),$("#canvas-container").height(Math.round($("#canvas-container").width()/gridRows)*gridRows)}function setMapStyle(e){e.global&&e.global.style&&(mapLineWidth=e.global.style.mapLineWidth||mapLineWidth,mapStationStyle=e.global.style.mapStationStyle||mapStationStyle)}function isMapStretchable(e){return e?e<=120:gridRows<=120&&gridCols<=120}function loadMapFromObject(e,t){if("object"!=typeof e&&(e=JSON.parse(e)),!t){drawGrid(),Object.keys(e.global.lines).length>0?$("#tool-line-options button.original-rail-line").remove():e.global.lines={bd1038:{displayName:"Red Line"},df8600:{displayName:"Orange Line"},f0ce15:{displayName:"Yellow Line"},"00b251":{displayName:"Green Line"},"0896d7":{displayName:"Blue Line"},"662c90":{displayName:"Purple Line"},a2a2a2:{displayName:"Silver Line"},"000000":{displayName:"Logo"},"79bde9":{displayName:"Rivers"},cfe4a7:{displayName:"Parks"}};var i=1;for(var a in e.global.lines)e.global.lines.hasOwnProperty(a)&&null===document.getElementById("rail-line-"+a)&&(keyboardShortcut=i<11?' data-toggle="tooltip" title="Keyboard shortcut: '+numberKeys[i-1].replace("Digit","")+'"':i<21?' data-toggle="tooltip" title="Keyboard shortcut: Shift + '+numberKeys[i-1].replace("Digit","")+'"':i<31?' data-toggle="tooltip" title="Keyboard shortcut: Alt + '+numberKeys[i-1].replace("Digit","")+'"':"",$("#rail-line-new").before('<button id="rail-line-'+a+'" class="rail-line has-tooltip" style="background-color: #'+a+';"'+keyboardShortcut+">"+e.global.lines[a].displayName+"</button>"),i++);$((function(){$('[data-toggle="tooltip"]').tooltip({container:"body"}),bindRailLineEvents(),resetRailLineTooltips(),$(".visible-xs").is(":visible")&&($("#canvas-container").removeClass("hidden-xs"),$("#tool-export-canvas").click(),$("#try-on-mobile").attr("disabled",!1))}))}}function updateMapObject(e,t,i,a){if(activeMap)var o=activeMap;else o=JSON.parse(window.localStorage.getItem("metroMap"));if(2==mapDataVersion&&"line"==activeTool&&(o.points_by_color[a]&&o.points_by_color[a].xys||(o.points_by_color[a]={xys:{}})),"eraser"==activeTool)return 2==mapDataVersion?(a||(a=getActiveLine(e,t,o)),o.points_by_color&&o.points_by_color[a]&&o.points_by_color[a].xys&&o.points_by_color[a].xys[e]&&o.points_by_color[a].xys[e][t]&&delete o.points_by_color[a].xys[e][t],o.stations&&o.stations[e]&&o.stations[e][t]&&delete o.stations[e][t]):1==mapDataVersion&&o[e]&&o[e][t]&&delete o[e][t],o;if(1==mapDataVersion&&(o.hasOwnProperty(e)?o[e].hasOwnProperty(t)||(o[e][t]={}):(o[e]={},o[e][t]={})),2==mapDataVersion&&"line"==activeTool)for(var n in o.points_by_color[a].xys[e]||(o.points_by_color[a].xys[e]={}),o.points_by_color[a].xys[e][t]=1,o.points_by_color)n!=a&&o.points_by_color[n].xys&&o.points_by_color[n].xys[e]&&o.points_by_color[n].xys[e][t]&&delete o.points_by_color[n].xys[e][t];else 1==mapDataVersion&&"line"==activeTool?o[e][t].line=a:"station"==activeTool&&(2==mapDataVersion?(o.stations||(o.stations={}),o.stations[e]||(o.stations[e]={}),o.stations[e][t]||(o.stations[e][t]={}),o.stations[e][t][i]=a):o[e][t].station[i]=a);return o}function moveMap(e){if("station"!=activeTool||!$("#tool-station-options").is(":visible")){var t=0,i=0;if("left"==e)t=-1;else if("right"==e)t=1;else if("down"==e)i=1;else if("up"==e)i=-1;if(2==mapDataVersion){var a={},o={};for(var n in activeMap.points_by_color)for(var l in a[n]={xys:{}},activeMap.points_by_color[n].xys)for(var r in activeMap.points_by_color[n].xys[l])if(l=parseInt(l),r=parseInt(r),Number.isInteger(l)&&Number.isInteger(r)){if(a[n].xys[l+t]||(a[n].xys[l+t]={}),0==l&&"left"==e)return;if(l==gridCols-1&&"right"==e)return;if(0==r&&"up"==e)return;if(r==gridRows-1&&"down"==e)return;0<=l&&l<gridCols&&0<=r&&r<gridCols&&0<=l+t&&l+t<gridCols&&0<=r+i&&r+i<gridCols&&(a[n].xys[l+t][r+i]=activeMap.points_by_color[n].xys[l][r],activeMap.stations&&activeMap.stations[l]&&activeMap.stations[l][r]&&(o[l+t]||(o[l+t]={}),o[l+t][r+i]=activeMap.stations[l][r]))}activeMap.points_by_color=a,activeMap.stations=o}else if(1==mapDataVersion){for(var l in newMapObject={},activeMap)for(var r in activeMap[l])l=parseInt(l),r=parseInt(r),Number.isInteger(l)&&Number.isInteger(r)&&(newMapObject[l+t]||(newMapObject[l+t]={}),0<=l&&l<gridCols&&0<=r&&r<gridCols&&0<=l+t&&l+t<gridCols&&0<=r+i&&r+i<gridCols&&(newMapObject[l+t][r+i]=activeMap[l][r]));newMapObject.global=activeMap.global,activeMap=newMapObject}return drawCanvas(activeMap),!0}}function disableRightClick(e){e.preventDefault()}function enableRightClick(){document.getElementById("grid-canvas").removeEventListener("contextmenu",disableRightClick),document.getElementById("hover-canvas").removeEventListener("contextmenu",disableRightClick)}function getCanvasXY(e,t){var i=$("#canvas-container"),a=i.width(),o=i.height(),n=parseInt($("#main-container").css("padding-left")),l=parseInt($("#main-container").css("margin-top"))+parseInt($("#mobile-header").height());e=parseInt(e)-n,t=parseInt(t)-l;var r=Math.round(e/a*gridCols),s=Math.round(t/o*gridRows);return r<0?r=0:r>=gridCols&&(r=gridCols-1),s<0?s=0:s>=gridRows&&(s=gridRows-1),[r,s]}function floodFill(e,t,i,a,o){if(i!=a&&e&&t){var n=!1,l=spanBelow=0,r=[e,t],s={};if(o){var c=document.getElementById("hover-canvas");c.getContext("2d").clearRect(0,0,c.width,c.height)}for(;r.length>0;){for(t=r.pop(),n=e=r.pop();n>=0&&getActiveLine(n,t,activeMap)==i;)n--;for(n++,l=spanBelow=0;n<gridCols&&getActiveLine(n,t,activeMap)==i;){if(o){if(s&&s[n]&&s[n][t])break;s.hasOwnProperty(n)||(s[n]={}),drawHoverIndicator(n,t,a,.5),s[n][t]=!0}else updateMapObject(n,t,"line",a);!l&&t>0&&getActiveLine(n,t-1,activeMap)==i?(r.push(n,t-1),l=1):l&&t>0&&getActiveLine(n,t-1,activeMap)!=i&&(l=0),!spanBelow&&t<gridRows-1&&getActiveLine(n,t+1,activeMap)==i?(r.push(n,t+1),spanBelow=1):spanBelow&&t<gridRows-1&&getActiveLine(n,t+1,activeMap)!=i&&(spanBelow=0),n++}}}}function combineCanvases(){drawCanvas(activeMap);var e=document.getElementById("metro-map-canvas"),t=document.getElementById("metro-map-stations-canvas");return e.getContext("2d",{alpha:!1}).drawImage(t,0,0),t.getContext("2d",{alpha:!0}).clearRect(0,0,t.width,t.height),e}function downloadImage(e,t){var i="metromapmaker.png";if(HTMLCanvasElement.prototype.toBlob)pngUrl&&URL.revokeObjectURL(pngUrl),e.toBlob((function(e){pngUrl=URL.createObjectURL(e),$("#metro-map-image-download-link").attr({download:i,href:pngUrl}),t?($("#grid-canvas").hide(),$("#hover-canvas").hide(),$("#metro-map-canvas").hide(),$("#metro-map-stations-canvas").hide(),$("#metro-map-image").attr("src",pngUrl),$("#metro-map-image").show()):(document.getElementById("metro-map-image-download-link").click(),drawCanvas(activeMap))}));else{var a=e.toDataURL();$("#metro-map-image-download-link").attr({download:i,href:a}),t?($("#grid-canvas").hide(),$("#hover-canvas").hide(),$("#metro-map-canvas").hide(),$("#metro-map-stations-canvas").hide(),$("#metro-map-image").attr("src",a),$("#metro-map-image").show()):(document.getElementById("metro-map-image-download-link").click(),drawCanvas(activeMap))}}function resetResizeButtons(e){$(".resize-grid").each((function(){if("Current"==$(this).html().split(" ")[0]){var e=$(this).attr("id").split("-").slice(2),t="("+e+"x"+e+")";80==e?t="Small "+t:120==e?t="Medium "+t:160==e?t="Large "+t:200==e?t="Extra Large "+t:240==e&&(t="XXL "+t),$(this).html(t)}})),$("#tool-resize-"+e).text("Current Size ("+e+"x"+e+")"),isMapStretchable(e)?($("#tool-resize-stretch").show(),$("#tool-resize-stretch").text("Stretch map to "+2*e+"x"+2*e)):$("#tool-resize-stretch").hide()}function throttle(e,t){let i=!0;return function(...a){i&&(i=!1,e.apply(this,a),setTimeout((()=>i=!0),t))}}function resetTooltipOrientation(){tooltipOrientation="",window.innerWidth<=768?tooltipOrientation="top":$("#snap-controls-right").is(":hidden")?tooltipOrientation="left":tooltipOrientation="right",$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement=tooltipOrientation)}))}function resetRailLineTooltips(){for(var e=$(".rail-line"),t="",i=0;i<e.length;i++){var a=$(".rail-line")[i].id.slice(10,16);t=i<10?"Keyboard shortcut: "+numberKeys[i].replace("Digit",""):i<20?"Keyboard shortcut: Shift + "+numberKeys[i].replace("Digit",""):i<30?"Keyboard shortcut: Alt + "+numberKeys[i].replace("Digit",""):"",$("#rail-line-"+a).attr("title",t).tooltip("fixTitle")}resetTooltipOrientation()}function showGrid(){$("canvas#grid-canvas").removeClass("hide-gridlines"),$("canvas#grid-canvas").css("opacity",1),$("#tool-grid span").html("<b><u>H</u></b>ide grid")}function hideGrid(){$("canvas#grid-canvas").addClass("hide-gridlines"),$("canvas#grid-canvas").css("opacity",0),$("#tool-grid span").html("S<b><u>h</u></b>ow grid")}function setFloodFillUI(){if($("#tool-flood-fill").prop("checked"))$("#tool-line-icon-pencil").hide(),$("#tool-line-caption-draw").hide(),$("#tool-line-icon-paint-bucket").show(),$("#tool-eraser-icon-paint-bucket").show(),$("#tool-eraser-icon-eraser").hide(),$("#tool-eraser-caption-eraser").hide(),menuIsCollapsed||($("#tool-line-caption-fill").show(),$("#tool-eraser-caption-fill").show()),("line"==activeTool&&activeToolOption||"eraser"==activeTool)&&(indicatorColor="line"==activeTool&&activeToolOption?activeToolOption:"#ffffff",floodFill(hoverX,hoverY,getActiveLine(hoverX,hoverY,activeMap),indicatorColor,!0));else{$("#tool-line-icon-pencil").show(),$("#tool-eraser-icon-eraser").show(),$("#tool-line-icon-paint-bucket").hide(),$("#tool-line-caption-fill").hide(),menuIsCollapsed||($("#tool-line-caption-draw").show(),$("#tool-eraser-caption-eraser").show()),$("#tool-eraser-icon-paint-bucket").hide(),$("#tool-eraser-caption-fill").hide(),$("#tool-eraser-options").hide();var e=document.getElementById("hover-canvas");e.getContext("2d").clearRect(0,0,e.width,e.height),("line"==activeTool&&activeToolOption||"eraser"==activeTool)&&(indicatorColor="line"==activeTool&&activeToolOption?activeToolOption:"#ffffff",drawHoverIndicator(hoverX,hoverY,indicatorColor))}}function setURLAfterSave(e){window.location.href.split("=")[0]}function getSurroundingLine(e,t,i){return getActiveLine((e=parseInt(e))-1,t=parseInt(t),i)&&getActiveLine(e-1,t,i)==getActiveLine(e+1,t,i)?getActiveLine(e-1,t,i):getActiveLine(e,t-1,i)&&getActiveLine(e,t-1,i)==getActiveLine(e,t+1,i)?getActiveLine(e,t-1,i):getActiveLine(e-1,t-1,i)&&getActiveLine(e-1,t-1,i)==getActiveLine(e+1,t+1,i)?getActiveLine(e-1,t-1,i):getActiveLine(e-1,t+1,i)&&getActiveLine(e-1,t+1,i)==getActiveLine(e+1,t-1,i)?getActiveLine(e-1,t+1,i):void 0}function setAllStationOrientations(e,t){if(t=parseInt(t),-1!=ALLOWED_ORIENTATIONS.indexOf(t))if(2==mapDataVersion)for(var i in e.stations)for(var a in e.stations[i])i=parseInt(i),a=parseInt(a),e.stations[i][a].orientation=t;else if(1==mapDataVersion)for(var i in e)for(var a in e[i])i=parseInt(i),a=parseInt(a),Number.isInteger(i)&&Number.isInteger(a)&&-1!=Object.keys(e[i][a]).indexOf("station")&&(e[i][a].station.orientation=t)}function resetAllStationStyles(e){if(2==mapDataVersion)for(var t in e.stations)for(var i in e.stations[t])t=parseInt(t),i=parseInt(i),e.stations[t][i].style&&delete e.stations[t][i].style;else if(1==mapDataVersion)for(var t in e)for(var i in e[t])t=parseInt(t),i=parseInt(i),Number.isInteger(t)&&Number.isInteger(i)&&-1!=Object.keys(e[t][i]).indexOf("station")&&-1!=Object.keys(e[t][i].station).indexOf("style")&&delete e[t][i].station.style}function getLineDirection(e,t,i){return e=parseInt(e),t=parseInt(t),origin=getActiveLine(e,t,i),NW=getActiveLine(e-1,t-1,i),NE=getActiveLine(e+1,t-1,i),SW=getActiveLine(e-1,t+1,i),SE=getActiveLine(e+1,t+1,i),N=getActiveLine(e,t-1,i),E=getActiveLine(e+1,t,i),S=getActiveLine(e,t+1,i),W=getActiveLine(e-1,t,i),info={direction:!1,endcap:!1},origin?(origin==W&&W==E?info.direction="horizontal":origin==N&&N==S?info.direction="vertical":origin==NW&&NW==SE?info.direction="diagonal-se":origin==SW&&SW==NE?info.direction="diagonal-ne":origin==W||origin==E?(info.direction="horizontal",info.endcap=!0):origin==N||origin==S?(info.direction="vertical",info.endcap=!0):origin==NW||origin==SE?(info.direction="diagonal-se",info.endcap=!0):origin==SW||origin==NE?(info.direction="diagonal-ne",info.endcap=!0):info.direction="singleton",info):info}function getConnectedStations(e,t,i){if(getStation(e=parseInt(e),t=parseInt(t),i)){var a=getStation(e-1,t-1,i),o=getStation(e+1,t-1,i),n=getStation(e-1,t+1,i),l=getStation(e+1,t+1,i),r=getStation(e,t-1,i),s=getStation(e+1,t,i),c=getStation(e,t+1,i),p=getStation(e-1,t,i);if(!(a||o||n||l||r||s||c||p))return"singleton";var d={highest:{E:0,S:0,SE:0,NE:0},E:{},S:{},N:{},W:{},NE:{},SE:{},SW:{},NW:{}};if(s&&u(s)){var v=e,g=t;do{v+=1}while(u(getStation(v,g,i)));d.E={x1:v-1,y1:g},d.highest.E=v-e-1}if(c&&u(c)){v=e,g=t;do{g+=1}while(u(getStation(v,g,i)));d.S={x1:v,y1:g-1},d.highest.S=g-t-1}if(o&&u(o)){v=e,g=t;do{v+=1,g-=1}while(u(getStation(v,g,i)));d.NE={x1:v-1,y1:g+1},d.highest.NE=v-e-1}if(l&&u(l)){v=e,g=t;do{v+=1,g+=1}while(u(getStation(v,g,i)));d.SE={x1:v-1,y1:g-1},d.highest.SE=v-e-1}if(p&&u(p)){v=e,g=t;do{v-=1}while(u(getStation(v,g,i)));d.W={x1:v+1,y1:g},d.E.internal=!0,d.highest.E+=Math.abs(v-e)-1}if(r&&u(r)){v=e,g=t;do{g-=1}while(u(getStation(v,g,i)));d.N={x1:v,y1:g+1},d.S.internal=!0,d.highest.S+=Math.abs(g-t)-1}if(a&&u(a)){v=e,g=t;do{v-=1,g-=1}while(u(getStation(v,g,i)));d.NW={x1:v+1,y1:g+1},d.SE.internal=!0,d.highest.SE+=Math.abs(v-e)-1}if(n&&u(n)){v=e,g=t;do{v-=1,g+=1}while(u(getStation(v,g,i)));d.SW={x1:v+1,y1:g-1},d.NE.internal=!0,d.highest.NE+=Math.abs(v-e)-1}var m=Object.values(d.highest).filter((e=>e>0)),h=Math.max(...Object.values(m));if(0==m.length)return"singleton";if(m.indexOf(h)!=m.lastIndexOf(h))return"conflicting";var f=Object.keys(d.highest).filter((e=>!0!==Number.isNaN(e))).sort((function(e,t){return d.highest[e]-d.highest[t]})).reverse();return!f||!f[0]||!d[f[0]].internal&&{x0:e,y0:t,x1:d[f[0]].x1,y1:d[f[0]].y1}}function u(e){return!!e&&("rect"==e.style||"rect-round"==e.style||"circles-thin"==e.style||!(e.style||"rect"!=mapStationStyle&&"rect-round"!=mapStationStyle&&"circles-thin"!=mapStationStyle))}}function stretchMap(e){e||(e=activeMap);var t={};if(t.global=Object.assign({},activeMap.global),2==mapDataVersion){for(var i in t.points_by_color={},e.points_by_color)for(var a in t.points_by_color[i]={xys:{}},e.points_by_color[i].xys)for(var o in e.points_by_color[i].xys[a])a=parseInt(a),o=parseInt(o),e.points_by_color[i].xys[a][o]&&(2*a>ALLOWED_SIZES[ALLOWED_SIZES.length-1]-1||2*o>ALLOWED_SIZES[ALLOWED_SIZES.length-1]-1||(t.points_by_color[i].xys.hasOwnProperty(2*a)||(t.points_by_color[i].xys[2*a]={}),t.points_by_color[i].xys[2*a][2*o]=e.points_by_color[i].xys[a][o]));for(var a in setMapSize(t),resetResizeButtons(gridCols),t.stations={},e.stations)for(var o in e.stations[a])a=parseInt(a),o=parseInt(o),2*a>=gridRows||2*o>=gridCols||(t.stations.hasOwnProperty(2*a)||(t.stations[2*a]={}),t.stations[2*a][2*o]=Object.assign({},e.stations[a][o]));for(a=1;a<gridRows;a++)for(o=1;o<gridCols;o++){(i=getSurroundingLine(a,o,t))&&(t.points_by_color[i].xys.hasOwnProperty(a)||(t.points_by_color[i].xys[a]={}),t.points_by_color[i].xys[a][o]=1)}}else if(1==mapDataVersion){for(var a in e)for(var o in e[a])a=parseInt(a),o=parseInt(o),Number.isInteger(a)&&Number.isInteger(o)&&(t.hasOwnProperty(2*a)||(t[2*a]={}),t[2*a][2*o]=e[a][o]);setMapSize(t),resetResizeButtons(gridCols);for(a=1;a<gridRows;a++)for(o=1;o<gridCols;o++){var n=getSurroundingLine(a,o,t);n&&(t.hasOwnProperty(a)||(t[a]={}),t[a][o]={line:n})}}return activeMap=t,loadMapFromObject(t),drawCanvas(t),t}function replaceColors(e,t){var i=JSON.stringify(activeMap);"object"==typeof e&&(e.name&&t.name&&(e.color&&$("#rail-line-"+e.color).text(t.name),i=i.replaceAll('"displayName":"'+e.name+'"','"displayName":"'+t.name+'"')),e.color&&t.color&&e.color.match("[a-fA-F0-9]{6}")&&t.color.match("[a-fA-F0-9]{6}")&&(i=i.replaceAll('"'+e.color+'"','"'+t.color+'"')),e.color!=t.color&&$("#rail-line-"+e.color).remove(),(i=JSON.parse(i)).global.lines[e.color]&&"object"==typeof t&&t.name&&(i.global.lines[e.color].displayName=t.name),loadMapFromObject(activeMap=i),drawCanvas(activeMap),autoSave(activeMap))}function editOnSmallScreen(){$("#mobile-header").removeClass("visible-xs"),$("#mobile-header").hide(),$("#mobile-header").css({height:0}),$("#controls").removeClass("hidden-xs"),collapseToolbox(),$("#snap-controls-left").trigger("click"),$("#tool-line").prop("disabled")&&$("#tool-export-canvas").click(),$("#grid-canvas").show(),$("#hover-canvas").show(),$("#metro-map-canvas").show(),$("#metro-map-stations-canvas").show(),$("#metro-map-image").hide(),$("#canvas-container").removeClass("hidden-xs"),snapCanvasToGrid(),drawCanvas()}function collapseToolbox(){menuIsCollapsed||(menuIsCollapsed=!0,$("#controls").addClass("collapsed"),$("#toolbox button span.button-label").hide(),$("#title, #remix, #credits, #rail-line-new, #rail-line-change, #rail-line-delete, #straight-line-assist-options, #flood-fill-options, #tool-move-all, #tool-move-options, #tool-resize-all, #tool-resize-options, #tool-map-style, #tool-map-style-options").hide(),$("#controls-collapse-menu").hide(),$("#tool-line-caption-draw").hide(),$("#tool-eraser-caption-eraser").hide(),$("#tool-line-caption-fill").hide(),$("#tool-eraser-caption-fill").hide(),$("#controls-expand-menu").show())}function expandToolbox(){if(menuIsCollapsed){menuIsCollapsed=!1,$("#controls").removeClass("collapsed");var e=$("#tool-line").attr("style");e&&$("#tool-line").attr("style",e),$("#controls").attr("style")&&$("#controls").attr("style").indexOf("left: 5px")>-1?$("#snap-controls-left").hide():$("#snap-controls-right").hide(),$("#toolbox button span.button-label").show(),$("#title, #remix, #credits, #rail-line-new, #rail-line-change, #rail-line-delete, #straight-line-assist-options, #flood-fill-options, #tool-move-all, #tool-resize-all, #tool-map-style").show(),$("#tool-move-all, #tool-resize-all").removeClass("width-100"),$("#tool-flood-fill").prop("checked")?($("#tool-line-caption-draw").hide(),$("#tool-eraser-caption-eraser").hide()):($("#tool-line-caption-fill").hide(),$("#tool-eraser-caption-fill").hide()),$("#controls-collapse-menu").show(),$("#controls-expand-menu").hide()}}function colorInUse(e){if(!(activeMap&&activeMap.points_by_color&&activeMap.points_by_color[e]&&activeMap.points_by_color[e].xys))return!1;for(var t in activeMap.points_by_color[e].xys)for(var i in activeMap.points_by_color[e].xys[t])if(1==activeMap.points_by_color[e].xys[t][i])return!0}function unfreezeMapControls(){window.innerWidth>768&&$("#tool-line").prop("disabled")&&$("#tool-export-canvas").click(),resetTooltipOrientation()}String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)},autoLoad(),$(document).ready((function(){document.getElementById("canvas-container").addEventListener("click",bindGridSquareEvents,!1),document.getElementById("canvas-container").addEventListener("mousedown",bindGridSquareMousedown,!1),document.getElementById("canvas-container").addEventListener("mousemove",throttle(bindGridSquareMouseover,1),!1),document.getElementById("canvas-container").addEventListener("mouseup",bindGridSquareMouseup,!1),window.addEventListener("resize",unfreezeMapControls),window.addEventListener("scroll",(function(){$(".tooltip").hide()})),mouseIsDown=!1,document.getElementById("grid-canvas").addEventListener("contextmenu",disableRightClick),document.getElementById("hover-canvas").addEventListener("contextmenu",disableRightClick),$((function(){$('[data-toggle="tooltip"]').tooltip({container:"body"}),window.innerWidth<=768&&$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement="top")}))})),document.addEventListener("keydown",(function(e){if(document.activeElement&&"text"==document.activeElement.type)"Enter"==e.key&&("new-rail-line-name"==document.activeElement.id?$("#create-new-rail-line").click():"change-line-name"==document.activeElement.id&&$("#save-rail-line-edits").click(),document.activeElement.blur());else{var t=$(".rail-line"),i=!1;"z"==e.key&&(e.metaKey||e.ctrlKey)?undo():"c"!=e.key||e.metaKey||e.ctrlKey?"d"==e.key?$("#tool-line").trigger("click"):"e"==e.key?$("#tool-eraser").trigger("click"):"f"==e.key?($("#tool-flood-fill").prop("checked")?$("#tool-flood-fill").prop("checked",!1):$("#tool-flood-fill").prop("checked",!0),setFloodFillUI()):"g"==e.key?$("#straight-line-assist").prop("checked")?$("#straight-line-assist").prop("checked",!1):$("#straight-line-assist").prop("checked",!0):"h"==e.key?$("#tool-grid").trigger("click"):"s"==e.key?$("#tool-station").trigger("click"):"x"!=e.key||e.metaKey||e.ctrlKey?"y"!=e.key||e.metaKey||e.ctrlKey?"ArrowLeft"!=e.key||e.metaKey||e.altKey?"ArrowUp"==e.key?(e.preventDefault(),moveMap("up")):"ArrowRight"!=e.key||e.metaKey||e.altKey?"ArrowDown"==e.key?(e.preventDefault(),moveMap("down")):"-"==e.key||"_"==e.key?$("#tool-zoom-out").trigger("click"):"="==e.key||"+"==e.key?$("#tool-zoom-in").trigger("click"):"BracketLeft"==e.code?$("#snap-controls-left").trigger("click"):"BracketRight"==e.code?$("#snap-controls-right").trigger("click"):!e.metaKey&&!e.ctrlKey&&e.shiftKey&&numberKeys.indexOf(e.code)>=0?i=numberKeys.indexOf(e.code)+10:!e.metaKey&&!e.ctrlKey&&e.altKey&&numberKeys.indexOf(e.code)>=0?i=numberKeys.indexOf(e.code)+20:!e.metaKey&&!e.ctrlKey&&numberKeys.indexOf(e.code)>=0&&(i=numberKeys.indexOf(e.code)):(e.preventDefault(),moveMap("right")):(e.preventDefault(),moveMap("left")):menuIsCollapsed||$("#tool-map-style").trigger("click"):$("#controls-expand-menu").trigger("click"):$("#controls-collapse-menu").trigger("click"),!1!==i&&t[i]&&t[i].click()}})),activeTool="look",$("#toolbox button:not(.rail-line)").on("click",(function(){$(".active").removeClass("active"),$(this).addClass("active"),"line"==activeTool?$("#tool-line").addClass("active"):"eraser"==activeTool?$("#tool-eraser").addClass("active"):"station"==activeTool&&$("#tool-station").addClass("active")})),$("#toolbox button.rail-line").on("click",(function(){$(".active").removeClass("active"),$("#tool-line").addClass("active")})),$("#tool-line").on("click",(function(){$(".active").removeClass("active"),$("#tool-line").addClass("active"),$(this).hasClass("draw-rail-line")&&activeToolOption?(activeTool="line",$(this).css({"background-color":activeToolOption})):"eraser"==activeTool&&activeToolOption?activeTool="line":"eraser"==activeTool&&(activeTool="look"),$("#tool-line-options").is(":visible")?($("#tool-line-options").hide(),$("#tool-new-line-options").hide(),$("#tool-station").hasClass("width-100")||$(this).removeClass("width-100")):($("#tool-line-options").show(),$(this).addClass("width-100")),$(".tooltip").hide()})),$("#tool-flood-fill").change((function(){setFloodFillUI()})),$("#rail-line-delete").click((function(){var e=$(".rail-line"),t=[],i=Object.assign({},activeMap);if("line"==activeTool&&(activeTool="look",$("#tool-line").attr("style",""),$("#tool-line").removeClass("active")),2==mapDataVersion)for(var a of e)colorInUse(a=a.id.slice(10,16))||(t.push($("#rail-line-"+a)),delete activeMap.global.lines[a]);else if(1==mapDataVersion){delete i.global,i=JSON.stringify(i);for(var o=0;o<e.length;o++)"rail-line-new"!=$(".rail-line")[o].id&&-1==i.indexOf('"line":"'+$(".rail-line")[o].id.slice(10,16)+'"')&&(t.push($("#"+$(".rail-line")[o].id)),delete activeMap.global.lines[$(".rail-line")[o].id.split("-").slice(2,3)])}if(t.length>0){for(var n=0;n<t.length;n++)t[n].remove();resetRailLineTooltips()}})),$("#tool-station").click((function(){activeTool="station",$(".active").removeClass("active"),$("#tool-station").addClass("active"),$("#tool-station-options").is(":visible")&&($("#tool-station-options").hide(),$(this).removeClass("width-100")),$(".tooltip").hide()})),$("#tool-eraser").on("click",(function(){activeTool="eraser",$(".active").removeClass("active"),$("#tool-eraser").addClass("active"),$("#tool-station-options").hide(),$(".tooltip").hide(),$("#tool-line").attr("style",""),$("#tool-line-options").is(":visible")||$("#tool-line").removeClass("width-100"),$("#tool-station").attr("style",""),$("#tool-station-options").is(":visible")||$("#tool-station").removeClass("width-100"),setFloodFillUI()})),$("#tool-grid").click((function(){$("canvas#grid-canvas").hasClass("hide-gridlines")?showGrid():hideGrid(),$(".tooltip").hide()})),$("#tool-zoom-in").click((function(){resizeCanvas("in")})),$("#tool-zoom-out").click((function(){resizeCanvas("out")})),$("#snap-controls-left").click((function(){$("#controls").css("left",5),$("#controls").css("right","unset"),$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement="right")})),$(this).hide(),$("#snap-controls-right").show()})),$("#snap-controls-right").click((function(){$("#controls").css("right",5),$("#controls").css("left","unset"),$(".has-tooltip").each((function(){$(this).data("bs.tooltip")&&($(this).data("bs.tooltip").options.placement="left")})),$(this).hide(),$("#snap-controls-left").show()})),$("#tool-resize-all").click((function(){$("#tool-resize-options").is(":visible")?($("#tool-resize-options").hide(),$(this).removeClass("width-100"),$(this).removeClass("active")):($("#tool-resize-options").show(),$(this).addClass("width-100"),isMapStretchable()?($("#tool-resize-stretch").show(),$("#tool-resize-stretch").text("Stretch map to "+2*gridRows+"x"+2*gridCols)):$("#tool-resize-stretch").hide()),$(".tooltip").hide()})),$(".resize-grid").click((function(){autoSave(activeMap);var e=activeTool;activeTool="resize",size=$(this).attr("id").split("-").slice(2),resetResizeButtons(size),resizeGrid(size),activeTool=e})),$("#tool-resize-stretch").click((function(){autoSave(activeMap),stretchMap()})),$("#tool-move-all").on("click",(function(){$("#tool-move-options").is(":visible")?($("#tool-move-options").hide(),$(this).removeClass("active"),$(this).removeClass("width-100")):($("#tool-move-options").show(),$(this).addClass("width-100")),$(".tooltip").hide()})),$("#tool-move-up").click((function(){moveMap("up")})),$("#tool-move-down").click((function(){moveMap("down")})),$("#tool-move-left").click((function(){moveMap("left")})),$("#tool-move-right").click((function(){moveMap("right")})),$("#tool-save-map").click((function(){activeTool="look";var e=JSON.stringify(activeMap);autoSave(e);csrftoken=getCookie("csrftoken"),$.post("/save/",{metroMap:e,csrfmiddlewaretoken:csrftoken}).done((function(e){if(e.replace(/\n/g,"").indexOf("No points_by_color")>-1)$("#tool-save-options").html('<h5 class="bg-danger">You can\'t save an empty map.</h5>'),$("#tool-save-options").show();else if("[ERROR]"==e.replace(/\s/g,"").slice(0,7))$("#tool-save-options").html('<h5 class="bg-danger">Sorry, there was a problem saving your map: '+e.slice(9)+"</h5>"),console.log("[WARN] Problem was: "+e),$("#tool-save-options").show();else{menuIsCollapsed&&$("#controls-expand-menu").trigger("click");var t=(e=e.split(","))[0].replace(/\s/g,""),i=e[1].replace(/\s/g,""),a='<button id="hide-save-share-url" class="styling-greenline width-100">Hide sharing explanation</button><h5 style="overflow-x: hidden;" class="text-left">Map Saved! You can share your map with a friend by using this link: <a id="shareable-map-link" href="/map/'+t+'" target="_blank">metromapmaker.com/map/'+t+'</a></h5> <h5 class="text-left">You can then share this URL with a friend - and they can remix your map without you losing your original! <b>If you make changes to this map, click Save &amp; Share again to get a new URL.</b></h5>';i&&(a+='<form id="name-map" class="text-left"><input type="hidden" name="urlhash" value="'+t+'"><input id="naming-token" type="hidden" name="naming_token" value="'+i+'"><label for="name">Where is this a map of?</label><input id="user-given-map-name" type="text" name="name"><select id="user-given-map-tags" name="tags"><option value="">What kind of map is this?</option><option value="real">This is a real metro system</option><option value="speculative">This is a real place, but a fantasy map</option><option value="unknown">This is an imaginary place</option></select></form><button id="name-this-map" class="styling-blueline width-100">Name this map</button>');var o=window.sessionStorage.getItem("userGivenMapName"),n=window.sessionStorage.getItem("userGivenMapTags");i&&o&&n&&(a+='<h5><a id="map-somewhere-else">Not a map of '+o+"? Click here to rename</a></h5>"),$("#tool-save-options").html("<fieldset><legend>Save &amp; Share</legend>"+a+"</fieldset>"),i&&o&&$("#user-given-map-name").val(o),i&&n&&$("#user-given-map-tags").val(n),$("#name-map").submit((function(e){e.preventDefault()})),$("#map-somewhere-else").click((function(){$("#name-map").show(),$("#name-this-map").show(),$(this).hide(),$("#name-this-map").removeClass(),$("#name-this-map").addClass("styling-blueline"),$("#name-this-map").text("Name this map")})),$("#name-this-map").click((function(e){$("#user-given-map-name").val($("#user-given-map-name").val().replaceAll("<","").replaceAll(">","").replaceAll('"',"").replaceAll("\\\\","").replace("&amp;","&").replaceAll("&","&amp;").replaceAll("/","-").replaceAll("'",""));var t=$("#name-map").serializeArray().reduce((function(e,t){return e[t.name]=t.value,e}),{});window.sessionStorage.setItem("userGivenMapName",$("#user-given-map-name").val()),window.sessionStorage.setItem("userGivenMapTags",$("#user-given-map-tags").val()),csrftoken=getCookie("csrftoken"),t.csrfmiddlewaretoken=csrftoken,$.post("/name/",t,(function(){$("#name-map").hide(),$("#name-this-map").text("Thanks!"),setTimeout((function(){$("#name-this-map").hide()}),500)}))})),i&&o&&n&&($("#user-given-map-name").show(),$("#user-given-map-tags").show(),$("#name-this-map").click(),$("#name-this-map").hide()),$("#tool-save-options").show(),$("#hide-save-share-url").click((function(){$("#tool-save-options").hide()}))}})).fail((function(e){if(400==e.status)var t="Sorry, your map could not be saved. Did you flood fill the whole map? Use flood fill with the eraser to erase and try again.";else if(500==e.status)t="Sorry, your map could not be saved right now. This may be a bug, and the admin has been notified.";else if(e.status>=502)t="Sorry, your map could not be saved right now. Metro Map Maker is currently undergoing routine maintenance including bugfixes and upgrades. Please try again in a few minutes.";$("#tool-save-options").html('<h5 class="text-left bg-warning">'+t+"</h5>"),$("#tool-save-options").show()})),$(".tooltip").hide()})),$("#tool-download-image").click((function(){activeTool="look",downloadImage(combineCanvases()),$(".tooltip").hide()})),$("#tool-export-canvas").click((function(){if(activeTool="look",drawCanvas(activeMap),$("#tool-station-options").hide(),$(".tooltip").hide(),$("#grid-canvas").is(":visible")){$("#grid-canvas").hide(),$("#hover-canvas").hide(),$("#metro-map-canvas").hide(),$("#metro-map-stations-canvas").hide();var e=document.getElementById("metro-map-canvas"),t=document.getElementById("metro-map-stations-canvas");e.getContext("2d",{alpha:!1}).drawImage(t,0,0);var i=e.toDataURL();$("#metro-map-image").attr("src",i),$("#metro-map-image").show(),$("#export-canvas-help").show(),$("button").attr("disabled",!0),$(this).attr("disabled",!1),$(this).attr("title","Go back to editing your map").tooltip("fixTitle").tooltip("show")}else $("#grid-canvas").show(),$("#hover-canvas").show(),$("#metro-map-canvas").show(),$("#metro-map-stations-canvas").show(),$("#metro-map-image").hide(),$("#export-canvas-help").hide(),$("button").attr("disabled",!1),$(this).attr("title","Download your map to share with friends").tooltip("fixTitle").tooltip("show")})),$("#tool-clear-map").click((function(){gridRows=80,gridCols=80,activeMap={global:Object.assign({},activeMap.global),points_by_color:{},stations:{}},drawGrid(),snapCanvasToGrid(),lastStrokeStyle=void 0,drawCanvas(activeMap,!1,!0),drawCanvas(activeMap,!0,!0),window.sessionStorage.removeItem("userGivenMapName"),window.sessionStorage.removeItem("userGivenMapTags"),$(".resize-grid").each((function(){var e=$(this).attr("id").split("-").slice(2),t="("+e+"x"+e+")";80==e?t="Current Size "+t:120==e?t="Medium "+t:160==e?t="Large "+t:200==e?t="XL "+t:240==e&&(t="XXL "+t),$(this).html(t)})),showGrid(),$(".tooltip").hide()})),$("#rail-line-new").click((function(){$("#tool-new-line-options").is(":visible")?($(this).children("span").text("Add New Line"),$("#tool-new-line-options").hide()):($(this).children("span").text("Hide Add Line options"),$("#tool-new-line-options").show())})),$("#create-new-rail-line").click((function(){$("#new-rail-line-name").val($("#new-rail-line-name").val().replaceAll("<","").replaceAll(">","").replaceAll('"',"").replaceAll("\\\\","").replaceAll("/","-"));var e=[],t=[];for(var i in $(".rail-line").each((function(){e.push($(this).attr("id").slice(10,16)),t.push($(this).text())})),""==$("#new-rail-line-color").val()&&$("#new-rail-line-color").val("#000000"),e.indexOf($("#new-rail-line-color").val().slice(1,7))>=0?$("#tool-new-line-errors").text("This color already exists! Please choose a new color."):t.indexOf($("#new-rail-line-name").val())>=0?$("#tool-new-line-errors").text("This rail line name already exists! Please choose a new name."):0==$("#new-rail-line-name").val().length?$("#tool-new-line-errors").text("This rail line name cannot be blank. Please enter a name."):$("#new-rail-line-name").val().length>100?$("#tool-new-line-errors").text("This rail line name is too long. Please shorten it."):$(".rail-line").length>99?$("#tool-new-line-errors").text("Too many rail lines! Delete your unused ones before creating new ones."):($("#tool-new-line-errors").text(""),$("#rail-line-new").before('<button id="rail-line-'+$("#new-rail-line-color").val().slice(1,7)+'" class="rail-line has-tooltip" style="background-color: '+$("#new-rail-line-color").val()+';">'+$("#new-rail-line-name").val()+"</button>"),activeMap.global||(activeMap.global={lines:{}}),activeMap.global.lines||(activeMap.global.lines={}),$(".rail-line").each((function(){"rail-line-new"!=$(this).attr("id")&&(activeMap.global.lines[$(this).attr("id").slice(10,16)]={displayName:$(this).text()})}))),bindRailLineEvents(),resetRailLineTooltips(),$("#tool-lines-to-change").html("<option>Edit which rail line?</option>"),activeMap.global.lines)$("#tool-lines-to-change").append('<option value="'+i+'">'+activeMap.global.lines[i].displayName+"</option>")})),$("#rail-line-change").click((function(){for(var e in $("#tool-change-line-options").is(":visible")?($(this).children("span").html("Edit colors &amp; names"),$("#tool-change-line-options").hide()):($(this).children("span").text("Close Edit Line options"),$("#tool-change-line-options").show()),$("#tool-lines-to-change").html("<option>Edit which rail line?</option>"),$("#change-line-name").hide(),$("#change-line-color").hide(),$("#tool-change-line-options label").hide(),$("#tool-change-line-options p").text(""),activeMap.global.lines)$("#tool-lines-to-change").append('<option value="'+e+'">'+activeMap.global.lines[e].displayName+"</option>")})),$("#tool-lines-to-change").on("change",(function(){$("#tool-change-line-options label").show(),"Edit which rail line?"!=$("#tool-lines-to-change option:selected").text()?($("#change-line-name").show(),$("#change-line-color").show(),$("#change-line-name").val($("#tool-lines-to-change option:selected").text()),$("#change-line-color").val("#"+$(this).val())):($("#tool-change-line-options p").text(""),$("#change-line-name").hide(),$("#change-line-color").hide())})),$("#save-rail-line-edits").click((function(){if("Edit which rail line?"!=$("#tool-lines-to-change option:selected").text()){var e=$("#tool-lines-to-change").val(),t=$("#change-line-color").val().slice(1),i=$("#tool-lines-to-change option:selected").text(),a=$("#change-line-name").val().replaceAll("<","").replaceAll(">","").replaceAll('"',"").replaceAll("\\\\","").replaceAll("/","-");e!=t&&Object.keys(activeMap.global.lines).indexOf(t)>=0?$("#cant-save-rail-line-edits").text("Can't change "+i+" - it has the same color as "+activeMap.global.lines[t].displayName):(replaceColors({color:e,name:i},{color:t,name:a}),$("#rail-line-change").html('<i class="fa fa-pencil" aria-hidden="true"></i> Edit colors &amp; names'),$("#cant-save-rail-line-edits").text(""),$("#tool-change-line-options").hide(),"line"==activeTool&&(activeTool="look",$("#tool-line").attr("style",""),$("#tool-line").removeClass("active")))}"line"==activeTool&&rgb2hex(activeToolOption).slice(1,7)==e&&(activeToolOption="#"+t),resetRailLineTooltips()})),$("#tool-map-style").on("click",(function(){$("#tool-map-style-options").toggle(),$("#tool-map-style-options").is(":visible")||$("#tool-map-style").removeClass("active"),$(".tooltip").hide(),.75==mapLineWidth?$("#tool-map-style-line-750").addClass("active-mapstyle"):$("#tool-map-style-line-"+1e3*mapLineWidth).addClass("active-mapstyle"),$("#tool-map-style-station-"+mapStationStyle).addClass("active-mapstyle")})),$(".map-style-line").on("click",(function(){mapLineWidth="tool-map-style-line-750"==$(this).attr("id")?.75:1/parseInt($(this).data("line-width-divisor")),$(".map-style-line.active-mapstyle").removeClass("active-mapstyle"),$(this).addClass("active-mapstyle"),activeMap&&activeMap.global&&activeMap.global.style?activeMap.global.style.mapLineWidth=mapLineWidth:activeMap&&activeMap.global&&(activeMap.global.style={mapLineWidth:mapLineWidth}),drawCanvas()})),$(".map-style-station").on("click",(function(){autoSave(activeMap),mapStationStyle=$(this).data("station-style"),$(".map-style-station.active-mapstyle").removeClass("active-mapstyle"),$(this).addClass("active-mapstyle"),$("#reset-all-station-styles").text("Set ALL stations to "+$(this).text()),activeMap&&activeMap.global&&activeMap.global.style?activeMap.global.style.mapStationStyle=mapStationStyle:activeMap&&activeMap.global&&(activeMap.global.style={mapStationStyle:mapStationStyle}),drawCanvas()})),$("#station-name").change((function(){$(this).val($(this).val().replaceAll('"',"").replaceAll("'","").replaceAll("<","").replaceAll(">","").replaceAll("&","").replaceAll("/","").replaceAll("_"," ").replaceAll("\\\\","").replaceAll("%",""));var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val();Object.keys(temporaryStation).length>0&&(2==mapDataVersion?(activeMap.stations||(activeMap.stations={}),activeMap.stations[e]||(activeMap.stations[e]={}),activeMap.stations[e][t]=Object.assign({},temporaryStation)):activeMap[e][t].station=Object.assign({},temporaryStation),temporaryStation={}),metroMap=updateMapObject(e,t,"name",$("#station-name").val()),autoSave(metroMap),drawCanvas(metroMap,!0)})),$("#station-name-orientation").change((function(){var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val(),i=parseInt($(this).val());e>=0&&t>=0&&(0==i?Object.keys(temporaryStation).length>0?temporaryStation.orientation=0:2==mapDataVersion?activeMap.stations[e][t].orientation=0:1==mapDataVersion&&(activeMap[e][t].station.orientation=0):ALLOWED_ORIENTATIONS.indexOf(i)>=0&&(Object.keys(temporaryStation).length>0?temporaryStation.orientation=i:2==mapDataVersion?activeMap.stations[e][t].orientation=i:1==mapDataVersion&&(activeMap[e][t].station.orientation=i))),window.localStorage.setItem("metroMapStationOrientation",i),0==Object.keys(temporaryStation).length&&autoSave(activeMap),drawCanvas(activeMap,!0),drawIndicator(e,t)})),$("#station-style").on("change",(function(){var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val(),i=$(this).val();e>=0&&t>=0&&(ALLOWED_STYLES.indexOf(i)>=0?Object.keys(temporaryStation).length>0?temporaryStation.style=i:2==mapDataVersion?activeMap.stations[e][t].style=i:1==mapDataVersion&&(activeMap[e][t].station.style=i):i||(2==mapDataVersion&&activeMap.stations[e][t].style?delete activeMap.stations[e][t].style:1==mapDataVersion&&activeMap[e][t].station.style&&delete activeMap[e][t].station.style)),0==Object.keys(temporaryStation).length&&autoSave(activeMap),drawCanvas(activeMap,!0),drawIndicator(e,t)})),$("#station-transfer").click((function(){var e=$("#station-coordinates-x").val(),t=$("#station-coordinates-y").val();e>=0&&t>=0&&($(this).is(":checked")?Object.keys(temporaryStation).length>0?temporaryStation.transfer=1:2==mapDataVersion?activeMap.stations[e][t].transfer=1:1==mapDataVersion&&(activeMap[e][t].station.transfer=1):Object.keys(temporaryStation).length>0?delete temporaryStation.transfer:2==mapDataVersion?delete activeMap.stations[e][t].transfer:1==mapDataVersion&&delete activeMap[e][t].station.transfer),0==Object.keys(temporaryStation).length&&autoSave(activeMap),drawCanvas(activeMap,!0),drawIndicator(e,t)})),$("#loading").remove()})),$("#set-all-station-name-orientation").on("click",(function(){autoSave(activeMap);var e=$("#set-all-station-name-orientation-choice").val();setAllStationOrientations(activeMap,e),drawCanvas(),setTimeout((function(){$("#set-all-station-name-orientation").removeClass("active")}),500)})),$("#reset-all-station-styles").on("click",(function(){autoSave(activeMap),resetAllStationStyles(activeMap),drawCanvas(),setTimeout((function(){$("#reset-all-station-styles").removeClass("active")}),500)})),$("#try-on-mobile").click((function(){editOnSmallScreen()})),$("#i-am-on-desktop").on("click",(function(){editOnSmallScreen(),$("#tool-export-canvas").remove(),$("#tool-download-image").removeClass("hidden-xs")})),$("#controls-collapse-menu").on("click",collapseToolbox),$("#controls-expand-menu").on("click",expandToolbox);